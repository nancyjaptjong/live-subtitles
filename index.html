<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Dutch → Papiamentu Subtitles</title>
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .topbar{
      position:fixed; top:0; left:0; right:0;
      padding:12px 16px; background:#111; color:#fff;
      display:flex; gap:10px; align-items:center; z-index:10000;
    }
    button{ padding:10px 14px; font-size:16px; cursor:pointer; }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .status{ margin-left:auto; }
    .page{
      padding-top:64px; min-height:calc(100vh - 64px);
      display:flex; align-items:center; justify-content:center;
      text-align:center; color:#333;
    }
    #subtitleBar{
      position:fixed; left:0; right:0; bottom:0;
      padding:18px 24px; font-size:32px; line-height:1.2;
      background:rgba(0,0,0,.75); color:#fff; text-align:center;
      z-index:9999; min-height:56px; user-select:none;
      white-space:pre-wrap;
    }
    #debugBar{
      position:fixed; left:0; right:0; bottom:86px;
      padding:10px 14px; font-size:14px;
      background:rgba(0,0,0,.55); color:#fff;
      z-index:9998; white-space:pre-wrap;
    }
    body.presentation .topbar { display:none; }
    body.presentation .page { padding-top:0; min-height:100vh; }
    body.presentation #debugBar { display:none; }
  </style>
</head>

<body>
  <div class="topbar">
    <button id="startBtn">Start</button>
    <button id="stopBtn" disabled>Stop</button>
    <span class="status" id="status">Idle</span>
  </div>

  <div class="page">
    <div>
      <h1 style="margin:0 0 8px;">Live Dutch → Papiamentu Subtitles</h1>
      <p style="margin:0; opacity:.8;">Click <b>Start</b>, allow mic, speak Dutch.</p>
      <p style="margin:12px 0 0; opacity:.7; font-size:14px;">
        Presentation mode: <code>?presentation=true</code>
      </p>
      <p style="margin:12px 0 0; opacity:.7; font-size:14px;">
        Tip: Chrome/Edge work best for Dutch SpeechRecognition.
      </p>
    </div>
  </div>

  <div id="debugBar"></div>
  <div id="subtitleBar"></div>

  <script>
    const DUTCH_LOCALE = "nl-NL";
    const TRANSLATE_ENDPOINT = "/translate";

    const params = new URLSearchParams(location.search);
    if (params.get("presentation") === "true") document.body.classList.add("presentation");

    const startBtn = document.getElementById("startBtn");
    const stopBtn  = document.getElementById("stopBtn");
    const statusEl = document.getElementById("status");
    const subtitleBar = document.getElementById("subtitleBar");
    const debugBar = document.getElementById("debugBar");

    const setStatus = (m) => statusEl.textContent = m;
    const setSubtitle = (t) => subtitleBar.textContent = t || "";
    const setDebug = (t) => debugBar.textContent = t || "";

    let recognition = null;
    let lastFinalDutch = "";
    let busy = false;

    async function translateDutch(dutchText) {
      const r = await fetch(TRANSLATE_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: dutchText })
      });

      const data = await r.json().catch(() => null);
      if (!r.ok) {
        throw new Error(`Translate error (${r.status}): ${JSON.stringify(data)}`);
      }
      const t = data?.translation?.toString()?.trim();
      if (!t) throw new Error("Empty translation");
      return t;
    }

    function startSpeech() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) throw new Error("SpeechRecognition not supported. Use Chrome or Edge.");

      recognition = new SR();
      recognition.lang = DUTCH_LOCALE;
      recognition.continuous = true;
      recognition.interimResults = true;

      recognition.onresult = async (event) => {
        let interim = "";
        let finalText = "";

        for (let i = event.resultIndex; i < event.results.length; i++) {
          const res = event.results[i];
          const txt = res[0]?.transcript || "";
          if (res.isFinal) finalText += txt;
          else interim += txt;
        }

        if (interim.trim()) setDebug("Dutch (listening): " + interim.trim());

        const cleaned = finalText.trim();
        if (!cleaned || cleaned === lastFinalDutch) return;

        lastFinalDutch = cleaned;
        setDebug("Dutch (final): " + cleaned);

        // prevent piling up requests if you speak fast
        if (busy) return;
        busy = true;

        try {
          setStatus("Translating…");
          const pap = await translateDutch(cleaned);
          setSubtitle(pap);
          setStatus("Live");
        } catch (e) {
          console.error(e);
          setStatus("ERROR: " + (e?.message || String(e)));
        } finally {
          busy = false;
        }
      };

      recognition.onerror = (e) => {
        console.error(e);
        setStatus("ERROR: speech recognition (" + (e.error || "unknown") + ")");
      };

      recognition.onend = () => {
        // auto-restart if user hasn't stopped
        if (startBtn.disabled) {
          try { recognition.start(); } catch {}
        }
      };

      recognition.start();
    }

    function stopSpeech() {
      if (recognition) {
        try { recognition.onend = null; } catch {}
        try { recognition.stop(); } catch {}
        recognition = null;
      }
    }

    async function startAll() {
      try {
        startBtn.disabled = true;
        stopBtn.disabled = false;
        setSubtitle("");
        setDebug("");
        setStatus("Listening…");
        startSpeech();
        setStatus("Live");
      } catch (e) {
        console.error(e);
        setStatus("ERROR: " + (e?.message || String(e)));
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    }

    async function stopAll() {
      stopBtn.disabled = true;
      stopSpeech();
      setStatus("Idle");
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }

    startBtn.onclick = startAll;
    stopBtn.onclick = stopAll;
    setStatus("Ready");
  </script>
</body>
</html>
